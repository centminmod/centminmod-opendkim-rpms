#
# Build libtomcrypt → Firebird 4 → OpenDBX → OpenDKIM for AlmaLinux 10
#
FROM almalinux/10-kitten-init

# ─── Repositories ────────────────────────────────────────────────
RUN dnf -y install dnf-plugins-core && \
    dnf -y config-manager --set-enabled crb && \
    dnf -y install epel-release && dnf clean all

# ─── Base tool-chain & common BuildRequires ──────────────────────
RUN dnf -y groupinstall "Development Tools" && \
    dnf -y install rpm-build rpmdevtools redhat-rpm-config \
       cmake ninja-build gcc-c++ make \
       openssl-devel openldap-devel sendmail-milter-devel libbsd-devel \
       mariadb-connector-c mariadb-connector-c-devel libpq-devel sqlite-devel \
       libicu-devel libtommath-devel libedit-devel libxml2-devel zlib-devel \
       ncurses-devel readline-devel docbook2X doxygen \
       automake autoconf gettext gettext-devel libtool \
       chrpath libstdc++-static procmail unzip sed \
       libevent-devel cyrus-sasl-devel libdb-devel \
       freetds-devel \
       systemd which curl && \
    dnf clean all

# ─── Non-root “builder” user (stores SRPMs) ──────────────────────
RUN useradd -m builder && su - builder -c "rpmdev-setuptree"
WORKDIR /home/builder
USER builder

# ─── Download all SRPMs we will rebuild ──────────────────────────
RUN curl -LO https://dl.fedoraproject.org/pub/epel/9/Everything/source/tree/Packages/l/libtomcrypt-1.18.2-12.el9.src.rpm && \
    curl -LO https://dl.fedoraproject.org/pub/epel/9/Everything/source/tree/Packages/f/firebird-4.0.0.2496-2.el9.src.rpm && \
    curl -LO https://vault.almalinux.org/10-kitten/BaseOS/Source/Packages/l/lua-5.4.6-7.el10.src.rpm && \
    curl -LO http://vault.almalinux.org/8.10/AppStream/Source/Packages/libmemcached-1.0.18-17.el8.src.rpm && \
    curl -LO https://dl.fedoraproject.org/pub/epel/9/Everything/source/tree/Packages/o/opendbx-1.4.6-38.el9.src.rpm && \
    curl -LO https://dl.fedoraproject.org/pub/epel/9/Everything/source/tree/Packages/o/opendkim-2.11.0-0.36.el9.src.rpm
