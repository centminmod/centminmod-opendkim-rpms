name: Build OpenDBX + OpenDKIM EL10 RPMs

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build builder image
      run: |
        docker build \
          -f dockerfiles/Dockerfile.rpmbuild-opendkim-el10 \
          -t opendkim-el10-build:latest .

    - run: mkdir -p output

    - name: Rebuild SRPMs and collect artefacts
      run: |
        docker run --rm -u root \
          -v ${{ github.workspace }}/output:/output \
          opendkim-el10-build:latest \
          bash -c '
            set -euo pipefail
            # Build OpenDBX
            rpm -ivh /home/builder/opendbx-*.src.rpm
            rpmbuild --define "_topdir /home/builder/rpmbuild" \
                     -ba /home/builder/rpmbuild/SPECS/opendbx.spec
            dnf -y install /home/builder/rpmbuild/RPMS/*/opendbx-[0-9]*.rpm \
                           /home/builder/rpmbuild/RPMS/*/opendbx-devel-[0-9]*.rpm

            # Build OpenDKIM (requires opendbx-devel now present)
            rpm -ivh /home/builder/opendkim-*.src.rpm
            rpmbuild --define "_topdir /home/builder/rpmbuild" \
                     -ba /home/builder/rpmbuild/SPECS/opendkim.spec

            # Copy ALL built RPMs/SRPMs out
            cp /home/builder/rpmbuild/RPMS/*/* /output/
            cp /home/builder/rpmbuild/SRPMS/* /output/
            ls -lAh /output/
          '

    - uses: actions/upload-artifact@v4
      with:
        name: opendkim-opendbx-el10-rpms
        path: output/*.rpm
