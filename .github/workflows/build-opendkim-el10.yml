name: Build Firebird + OpenDBX + OpenDKIM EL10 RPMs
on: { workflow_dispatch: }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build builder image
      run: |
        docker build -f dockerfiles/Dockerfile.rpmbuild-opendkim-el10 \
          -t mailstack-el10-build:latest .

    - run: mkdir -p output            # for artefacts

    - name: Rebuild SRPMs in sequence
      run: |
        docker run --rm -u root \
          -v ${{ github.workspace }}/output:/output \
          mailstack-el10-build:latest \
          bash -c '
            set -euo pipefail
            TOPDIR=/root/rpmbuild

            # -------- Firebird --------------------------------------------------
            rpm -ivh /home/builder/firebird-*.src.rpm
            rpmbuild --define "_topdir $TOPDIR" -ba $TOPDIR/SPECS/firebird.spec
            dnf -y install $TOPDIR/RPMS/*/firebird-{common,libs,devel}-*.rpm

            # -------- OpenDBX (Firebird yes, FreeTDS no) ------------------------
            rpm -ivh /home/builder/opendbx-*.src.rpm
            rpmbuild --define "_topdir $TOPDIR" -ba $TOPDIR/SPECS/opendbx.spec --without freetds
            dnf -y install $TOPDIR/RPMS/*/opendbx-{devel,*[0-9]}.rpm

            # -------- OpenDKIM --------------------------------------------------
            rpm -ivh /home/builder/opendkim-*.src.rpm
            rpmbuild --define "_topdir $TOPDIR" -ba $TOPDIR/SPECS/opendkim.spec

            # -------- Collect artefacts ----------------------------------------
            cp $TOPDIR/RPMS/*/*  $TOPDIR/SRPMS/*  /output/
            ls -lAh /output/
          '

    - uses: actions/upload-artifact@v4
      with:
        name: firebird-opendbx-opendkim-el10-rpms
        path: output/*.rpm
